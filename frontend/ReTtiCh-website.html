<!DOCTYPE html>
<html lang="en">
<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Sommute Insight Genius (ReTtiCh)</title>
	
	<link rel="shortcut icon" type="image/x-icon" href="https://dgalywyr863hv.cloudfront.net/pictures/strava_o_auth/applications/114307/28666771/1/large.jpg" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

	<script src="../frontend/dependencies/leaflet-motion/dist/leaflet.motion.js"></script>
	<script src="./data/data.js"></script>
	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 900px;
			width: 1000px;
			max-width: 100%;
			max-height: 100%;
		}
	</style

	
</head>
<body>



<div id="map" style="width: 4000px; height: 900px;"></div>
<script>

	const map = L.map('map').setView([50.896537, 7.025585], 12);

	const tiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map);
	const felix_all = (JSON.parse(felix_json));
	console.log(felix_all);
	const philipp_all = (JSON.parse(philipp_json));
	const flo_all = (JSON.parse(flo_json));


	const all_data = [philipp_all,felix_all,flo_all];



 	const felix_latlng = felix_all.latlng.data
	const philipp_latlng = philipp_all.latlng.data
	console.log(felix_latlng) 


    let felixIcon = L.icon({
		iconUrl: './piqs/felix.png',
		iconAnchor: [17, 17]
	}); 
	function draw(idx_set){
		// draws all data in all_all starting with the corresponding index. So index_set should be an array of indices with the same size as all_data
		let lat_lngs = [];
		let elapsed_times = [];
		for (let i=0; i < all_data.length; i++){
			full_json = all_data[i];
			sliced_latlng = full_json.latlng.data.slice(idx_set[i]);
			lat_lngs.push(sliced_latlng.map(([lat, lng]) => ({ lat, lng })));

			et = full_json.time.data.at(-1)-full_json.time.data[idx_set[i]];
			elapsed_times.push(et);
		}
		let duration_f =10000 / Math.max(...elapsed_times);
		let durations = elapsed_times.map(x => x * duration_f)

		var color;
	
		trackPolyLs = []	
		seqGroups = []	
		for (let i=0; i < all_data.length; i++){
			var r = Math.floor(Math.random() * 255);
			var g = Math.floor(Math.random() * 255);
			var b = Math.floor(Math.random() * 255);
			color= "rgb("+r+" ,"+g+","+ b+")"; 
			seqGroups.push(L.motion.seq([
				L.motion.polyline(lat_lngs[i], {color: color},{duration:durations[i]})
				]).addTo(map));
		}
		console.log(durations)
		for (seqGroup of seqGroups){
			seqGroup.motionStart();
		}
		//let trackPolyline = L.motion.polyline(conv_felix, {color: color},{duration:10000} ,{icon: felixIcon, showMarker:true, iconSize: L.point(27.5, 24)});
		return seqGroups

	}

	seqGroups = draw([1,1,1])

	function distance(p,q) {
    	return Math.sqrt(Math.pow(p[0] - q[0], 2) + Math.pow(p[1] - q[1], 2))
	}

	function findClosestIndex(arrayOP, point){
		// Claculates the index of the array of points for the closest to point
		// does not check the last index
		let dist = 99999999.0;
		let idx = -1;

		for (i = 0; i < arrayOP.length-1; i++){
			point_i = arrayOP[i];
			dist_i = distance(point_i,point)
			if (dist_i<dist){
				dist = dist_i;
				idx = i;
			}
		}
		return idx
	}

	function onMapClick(e) {

		idx_set = [];
		for (let i = 0; i < all_data.length; i++){
			full_json = all_data[i];
			idx_temp = findClosestIndex(full_json.latlng.data,[e.latlng.lat, e.latlng.lng]);
			idx_set.push(idx_temp);
		} 

		for (seqGroup of seqGroups){
			seqGroup.motionStop();
			seqGroup.removeFrom(map);
		}
		seqGroups = draw(idx_set)
	} 

	map.on('click', onMapClick);

</script>



</body>
</html>

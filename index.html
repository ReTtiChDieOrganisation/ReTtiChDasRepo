<!DOCTYPE html>
<html lang="en">

<!-- head -->
<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>ReTtiCh</title>
	
	<link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/ReTtiChDieOrganisation/ReTtiChDasRepo/main/pics/ReTtiChDasBild.png" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

	<script src="./frontend/dependencies/leaflet-motion/dist/leaflet.motion.js"></script>
	<script src="./frontend/data/strava/data.js"></script><!-- loads ALL_RIDES -->
	<script src="./frontend/data/strava/stats.json"></script><!-- loads ALL_STATS -->
	<script src="./frontend/data/rettich/riders.js"></script> <!-- loads RIDERS_PROFILE_INFO -->

	<script type="text/javascript" src="./frontend/data/rettich/icons.js"></script>

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
	<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<!-- body -->
<body>
	<section class="container">
		<div id = "map-container">
			<!-- map -->
			<div id="map">
				<script src="js/script.js"></script>
			</div>
			<!-- buttons auf map -->
			<!-- <button id="toggleButton" onClick="toggleFunction()">&#9208; </button> -->
			<!-- <button id="restartButton" onClick="rettich_motion_keys('restart')">Restart</button>
			<button id="speedupButton" onClick="rettich_motion_keys('speedup')">2x</button>
			<button id="slowdownButton" onClick="rettich_motion_keys('slowdown')">0.5x</button> -->
		</div>
	</div>

	<!-- buttons auf map -->
	<button id="toggleButton" onClick="toggleFunction()">&#9208; </button>
	<button id="restartButton" onClick="rettich_motion_keys('restart')">Restart</button>
	<button id="speedupButton" onClick="rettich_motion_keys('speedup')">2x</button>
	<button id="slowdownButton" onClick="rettich_motion_keys('slowdown')">0.5x</button>
	
	<!-- medals table -->
	<div class = "rightdivision" id="stats">
		<select id="sel_group" onchange="rettich_getComboGroup(this)">
			<option value="">--Please choose a group--</option>
		</select>


		<canvas id="myChart"></canvas>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		
		<script>
			function rettich_draw_medals(){
				if (typeof ALL_STATS=='string'){
				ALL_STATS = JSON.parse(ALL_STATS) // i still have no idea why i have to parse it here again
			}


			const ctx = document.getElementById('myChart');
			
			let medal_labels = ALL_STATS[CURRENT_GROUP]['riders']
			let medal_data_gold = []
			let medal_data_silver = []
			let medal_data_bronze = []
			for (const [ride_iterator, ride_id] of  ALL_STATS[CURRENT_GROUP].ride_ids.entries()) {
					medal_data_gold.push(ALL_STATS[CURRENT_GROUP]['medals'][ride_id][0])
					medal_data_silver.push(ALL_STATS[CURRENT_GROUP]['medals'][ride_id][1])
					medal_data_bronze.push(ALL_STATS[CURRENT_GROUP]['medals'][ride_id][2])
			}
			if (typeof medal_chart !== 'undefined') {
				medal_chart.destroy();
			}
			medal_chart = new Chart(ctx,
			{
				type: 'bar',
				data:
				{
					labels: medal_labels,
					datasets: [
					{
						label: 'Gold',
						data: medal_data_gold,
						borderWidth: 1,
						backgroundColor: "rgb(255,215,0)",
						stack: 'Stack 0',
					},
					{
						label: 'Silver',
						data: medal_data_silver,
						borderWidth: 1,
						backgroundColor: "rgb(208,208,208)",
						stack: 'Stack 1',
					},
					{
						label: 'Bronze',
						data: medal_data_bronze,
						borderWidth: 1,
						backgroundColor: "rgb(205,127,50)",
						stack: 'Stack 2',
					},]
				},
				options:
				{
					scales:
					{
						y: 
						{
							stacked: true,
							beginAtZero: true
						}
					}
				}
			});
			}
			rettich_draw_medals()
		</script>
	</div>

	<!-- choose segment table and adjust map to segment -->
	<div class = "rightdivision2" id="stats">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css" />
		<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>	

		<select id="sel_segment" onchange="rettich_getComboSegment(this)">
			<option value="">--Please choose a segment--</option>
		</select>
		
		<table id="stats_table" class="display" style="width:100%">
			<thead>
				<tr>
					<th>Rider</th>
					<th>Time [min:s]</th>
					<th>Speed [km/h]</th>
					<th>Power [W]</th>
				</tr>
			</thead>
			<tbody>

			</tbody>
		</table>
		
		<script>
			if (typeof ALL_STATS=='string'){
			 	ALL_STATS = JSON.parse(ALL_STATS) // i have no idea why i have to parse it here again
			}
			

			let myTable = document.getElementById("stats_table");
			

			$(function() {
			$.each(ALL_STATS, function(i, option) {
				$('#sel_group').append($('<option/>').attr("value", [i]).text(option['group_name']));
			});
		})

			//--------------- only script function definition below ---------------//
			function rettich_getComboGroup(selectObject) {
				
				value = selectObject.value; 
				key = selectObject;
				CURRENT_GROUP=value;
				rettich_draw_medals()
				rettich_remove_all_rides_from_map()
				//clear rettich_getComboSegment
				const group_select_segment = document.getElementById('sel_segment');
				group_select_segment.innerHTML = ''; 
				group_select_segment.add(new Option('--Please choose a segment--', ""));
				seqGroups = rettich_motion_draw_groups()

				const all_rides_segment_efforts = ALL_STATS[CURRENT_GROUP]['segments'];
				$(function() {
					$.each(all_rides_segment_efforts, function(i, option) {
						abcde = [i]
						for (ride_id of ALL_STATS[CURRENT_GROUP]['ride_ids']){
							abcde.push(option[ride_id].time)
						}
						$('#sel_segment').append($('<option/>').attr("value", abcde).text(i));
					});
				})
				
				//Clear table when selecting a new group
				const myTable = document.getElementById('stats_table');
				// Get a reference to the table body (tbody)
				const tbody = myTable.querySelector('tbody');

				// Clear the existing rows in the tbody
				while (tbody.firstChild) {
					tbody.removeChild(tbody.firstChild);
				}

				
				let bounds
				let bounds_temp
				for (const [ride_iterator, ride_id] of  ALL_STATS[CURRENT_GROUP].ride_ids.entries()){
					if (ride_iterator==0){
						bounds = L.latLngBounds(ALL_RIDES[ride_id]['latlng']['data'])
					}else{
						bounds_temp = L.latLngBounds(ALL_RIDES[ride_id]['latlng']['data'])
						bounds.extend(bounds_temp)
					}
				}
				map.fitBounds(bounds)

			}
			function rettich_getComboSegment(selectObject) {
				value = selectObject.value; 
				key = selectObject;

				
				seperated_values = value.split(',');
				segment_name = seperated_values[0];
				for (seqGroup of seqGroups){
					seqGroup.motionStop();
					seqGroup.removeFrom(map);
				
					if (typeof marker_start !== 'undefined'){
						map.removeLayer(marker_start);
					}

					if (typeof marker_finish !== 'undefined'){
						map.removeLayer(marker_finish);
					}
				}
				
				if (seperated_values==""){
					seqGroups = rettich_motion_draw_groups()
					map.setView([50.896537, 7.025585], 12);
				} 
				else {
					const myTable = document.getElementById('stats_table');
					let num_rides_at_current_segment = seperated_values.length-1;
					// Get a reference to the table body (tbody)
					const tbody = myTable.querySelector('tbody');

					// Clear the existing rows in the tbody
					while (tbody.firstChild) {
						tbody.removeChild(tbody.firstChild);
					}

					for (const [ride_iterator, ride_id] of  ALL_STATS[CURRENT_GROUP].ride_ids.entries()) {
						const row = tbody.insertRow();
						let cell = row.insertCell(0);
						cell.textContent = ALL_STATS[CURRENT_GROUP]['riders'][ride_iterator];
						cell = row.insertCell(1);
						cell.textContent = rettich_fancyTimeFormat(seperated_values[ride_iterator+1]);
						cell = row.insertCell(2);
						cell.textContent = Math.round(ALL_STATS[CURRENT_GROUP]['segments'][segment_name][ride_id]['speed']*100)/100;
						cell = row.insertCell(3);

						cell.textContent =  Math.round(ALL_STATS[CURRENT_GROUP]['segments'][segment_name][ride_id]['power']*100)/100;
					}
					
	
					rettich_motion_draw_segment(segment_name)
				}
			}

			function rettich_fancyTimeFormat(duration) {
				// Hours, minutes and seconds
				const hrs = ~~(duration / 3600);
				const mins = ~~((duration % 3600) / 60);
				const secs = ~~duration % 60;

				// Output like "1:01" or "4:03:59" or "123:03:59"
				let ret = "";

				if (hrs > 0) {
					ret += "" + hrs + ":" + (mins < 10 ? "0" : "");
				}

				ret += "" + mins + ":" + (secs < 10 ? "0" : "");
				ret += "" + secs;

				return ret;
			}

			function rettich_motion_draw_segment(seg_name) {
			
				
				start_idx_set = []
				end_idx_set = []
				for (const [ride_iterator,ride_id] of  ALL_STATS[CURRENT_GROUP].ride_ids.entries()) {
					start_idx_set.push(ALL_STATS[CURRENT_GROUP]['segments'][seg_name][ride_id]['start_index'])
					end_idx_set.push(ALL_STATS[CURRENT_GROUP]['segments'][seg_name][ride_id]['end_index'])
				}

				rettich_motion_draw_groups(start_idx_set,end_idx_set)
				marker_start = rettich_static_draw_marker(ALL_STATS[CURRENT_GROUP]['segments'][seg_name]['Segment']['start_latlng'], rettich_other_icons.start)
				marker_finish = rettich_static_draw_marker(ALL_STATS[CURRENT_GROUP]['segments'][seg_name]['Segment']['end_latlng'], rettich_other_icons.finish)
				
				bounds = L.latLngBounds(marker_start.getLatLng(), marker_finish.getLatLng())

				map.setView(center);
				map.fitBounds(bounds);
			}

			function rettich_static_draw_marker(latlng, marker_icon) {
				return L.marker(
					latlng, {
					icon: L.icon({
						iconUrl: marker_icon.icon,
						iconAnchor: marker_icon.anchor, 
						iconSize: marker_icon.size})}
				).addTo(map);
			}

			function rettich_get_segment_center(start, finish) {
				coefficient = 1;

				if ((start.getLatLng().lat > 90 && finish.getLatLng().lat < -90) || (finish.getLatLng().lat > 90 && start.getLatLng().lat < -90)) {
					midLat = 180 - ((start.getLatLng().lat - finish.getLatLng().lat) / 2).abs();
					
					// If output will be in the 1st quartile then co-ef will remain 1, if in 4th then it will be -1
					if ((start.getLatLng().lat < 0 && start.getLatLng().lat.abs() < finish.getLatLng().lat.abs()) ||
						(finish.getLatLng().lat < 0 && finish.getLatLng().lat.abs() < start.getLatLng().lat.abs())) {
						coefficient = -1;
					}
					
					// Applying coefficient
					midLat *= coefficient;
				}
				else {
					midLat = (finish.getLatLng().lat + start.getLatLng().lat) / 2;
				}
				
				// Calculating midLong
				coefficient = 1;

				if ((start.getLatLng().lng > 90 && finish.getLatLng().lng < -90) || (finish.getLatLng().lng > 90 && start.getLatLng().lng < -90)) {
					midLong = 180 - ((start.getLatLng().lng.abs() - finish.getLatLng().lng.abs()) / 2).abs();
					
					// If output will be in the 1st quartile then co-ef will remain 1, if in 4th then it will be -1
					if ((start.getLatLng().lng < 0 && start.getLatLng().lng.abs() < finish.getLatLng().lng.abs()) ||
						(finish.getLatLng().lng < 0 && finish.getLatLng().lng.abs() < start.getLatLng().lng.abs())) {
						coefficient = -1;
					}

					// Applying coefficient
					midLong *= coefficient;
				} 
				else {
					midLong = (finish.getLatLng().lng + start.getLatLng().lng) / 2;
				}

				return [midLat, midLong]
			}
		</script>
	</div>
	<!-- GitHub Icon Link -->
    <a href="https://github.com/ReTtiChDieOrganisation/ReTtiChDasRepo" target="_blank" id="github-icon">
        <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
            <image xlink:href="./icons/github-mark.svg" src="./icons/github-mark.png" width="32" height="32"/>
        </svg>
    </a>
</body>
</html>
